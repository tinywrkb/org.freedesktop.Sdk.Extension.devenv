From 8be03a26f4c0b8d16bde996043738f182d2f0ca4 Mon Sep 17 00:00:00 2001
From: tinywrkb <tinywrkb@gmail.com>
Date: Mon, 18 Jul 2022 15:49:48 +0300
Subject: [PATCH] add localstatedir bashrc support

---
 config-top.h |  3 +++
 shell.c      | 17 +++++++++++++----
 2 files changed, 16 insertions(+), 4 deletions(-)

diff --git a/config-top.h b/config-top.h
index c97168f..540150c 100644
--- a/config-top.h
+++ b/config-top.h
@@ -95,6 +95,9 @@
 /* System-wide .bashrc file for interactive shells. */
 #define SYS_BASHRC "/usr/lib/sdk/devenv/etc/bash.bashrc"
 
+/* Local-state .bashrc file for interactive shells. */
+#define STATE_BASHRC "/var/lib/devenv/etc/bash.bashrc"
+
 /* System-wide .bash_logout for login shells. */
 #define SYS_BASH_LOGOUT "/usr/lib/sdk/devenv/etc/bash.bash_logout"
 
diff --git a/shell.c b/shell.c
index ce8087f..8ad9206 100644
--- a/shell.c
+++ b/shell.c
@@ -1102,6 +1102,7 @@ run_startup_files ()
   int old_job_control;
 #endif
   int sourced_login, run_by_ssh;
+  int r;
 
   /* get the rshd/sshd case out of the way first. */
   if (interactive_shell == 0 && no_rc == 0 && login_shell == 0 &&
@@ -1120,10 +1121,14 @@ run_startup_files ()
 	{
 #ifdef SYS_BASHRC
 #  if defined (__OPENNT)
-	  maybe_execute_file (_prefixInstallPath(SYS_BASHRC, NULL, 0), 1);
+	  r = force_execute_file (_prefixInstallPath(SYS_BASHRC, NULL, 0), 1);
 #  else
-	  maybe_execute_file (SYS_BASHRC, 1);
+	  r = force_execute_file (SYS_BASHRC, 1);
 #  endif
+#endif
+#ifdef STATE_BASHRC
+	  if (r < 0)
+	    maybe_execute_file (STATE_BASHRC, 1);
 #endif
 	  maybe_execute_file (bashrc_file, 1);
 	  return;
@@ -1205,10 +1210,14 @@ run_startup_files ()
 	{
 #ifdef SYS_BASHRC
 #  if defined (__OPENNT)
-	  maybe_execute_file (_prefixInstallPath(SYS_BASHRC, NULL, 0), 1);
+	  r = force_execute_file (_prefixInstallPath(SYS_BASHRC, NULL, 0), 1);
 #  else
-	  maybe_execute_file (SYS_BASHRC, 1);
+	  r = force_execute_file (SYS_BASHRC, 1);
 #  endif
+#endif
+#ifdef STATE_BASHRC
+	  if (r < 0)
+	    maybe_execute_file (STATE_BASHRC, 1);
 #endif
 	  maybe_execute_file (bashrc_file, 1);
 	}
-- 
2.36.1

